name: Generate and push docs on dev

on:
  pull_request: 
  push:
    branches:
      - dev

permissions:
  contents: write  # Required for push

jobs:
  build-and-push-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # For Git history

      - name: Setup .NET  # DocFX requires .NET
        uses: actions/setup-dotnet@v5
        with:
          global-json-file: global.json

      - name: Display active .NET version
        run: dotnet --version  # Verify 10.x active [web:35]

      - name: Install docfx
        run: dotnet tool install --global docfx --version 2.78.3

      - name: Display tool list
        run: dotnet tool list --global
        
      - name: Display docfx version
        run: docfx -v
        
      - name: Build docfx
        run: docfx

      - name: Deploy to docs branch
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Fetch docs branch (create if missing)
          git fetch origin docs:docs || true
          git checkout docs || git checkout --orphan docs
          
          # Clear existing content
          git rm -rf . || true
          
          # Copy new docs
          cp -r _site/* .
          git add .
          
          # Commit and push
          git commit -m "Update docs from dev ($(date))" || echo "No changes"
          git push origin docs --force