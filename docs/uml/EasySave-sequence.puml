@startuml
title EasySave - Main sequence (UI or CLI) and job execution

actor User
participant Program
participant EasySaveApplication as App
participant ApplicationConfiguration as Config
participant DataPathResolver as DataPaths
participant PathService as Paths
participant JobRepository as Repo
participant StateFileService as State
participant "JsonLogWriter<LogEntry>" as LogWriter
participant StateSynchronizer as Sync
participant BackupService as Backup
participant BackupDirectoryPreparer as DirPrep
participant BackupFileSelector as Selector
participant FileCopier as Copier
participant UserInterface as UI
participant MainMenuController as Menu
participant JobLaunchView as Launch
participant CommandController as CLI
participant CommandJobRunner as Runner
participant ProgressWidget as Progress

Program -> App: Run(args)
App -> Config: Load()\nInstance
App -> DataPaths: ResolveDirectory(config/log)
App -> Paths: new()
App -> Repo: new(configDir)
App -> State: new(configDir)
App -> LogWriter: new(logDir)
App -> Selector: new(Paths)
App -> DirPrep: new(LogWriter, Paths)
App -> Copier: new()
App -> Backup: new(LogWriter, State, Paths, Selector, DirPrep, Copier)
App -> Sync: new(Repo, State)
App -> State: Initialize(Repo.Load())

alt args.Length > 0 (CLI mode)
  App -> CLI: Run(args, Repo, Backup, State, Paths)
  CLI -> Runner: RunJobs(ids)
  Runner -> Repo: Load()
  Runner -> State: Initialize(jobs)
  loop each id
    Runner -> Paths: TryNormalizeExistingDirectory(src/target)
    Runner -> Backup: RunJob(job)
  end
else interactive UI mode
  App -> UI: Initialize(Repo, Backup, State, Sync, Paths)
  App -> UI: ShowMenu()
  UI -> Menu: Show()
  User -> Menu: select "Launch backup"
  Menu -> Launch: Show()
  Launch -> Repo: Load()
  Launch -> Paths: TryNormalizeExistingDirectory(src/target)
  Launch -> Backup: RunJob(job)
end

activate Backup
Backup -> State: GetOrCreate(job)
Backup -> Paths: TryNormalizeExistingDirectory(src/target)
Backup -> LogWriter: Log(start)
Backup -> DirPrep: EnsureTargetDirectories(...)
Backup -> Selector: GetFilesToCopy(...)
Backup -> State: Update(state=start)
Backup -> Progress: new(SystemConsole)
loop each file
  Backup -> DirPrep: EnsureTargetDirectoryForFile(...)
  Backup -> State: Update(state=file_transfer)
  Backup -> Copier: Copy(source, target)
  Backup -> LogWriter: Log(file)
  Backup -> State: Update(progress)
  Backup -> Progress: UpdateProgress(%)
end
Backup -> State: Update(state=completed/failed)
Backup -> LogWriter: Log(end)
deactivate Backup
@enduml
